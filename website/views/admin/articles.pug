extends base_layout

block main-body-block
  div.main
    div#target-div
      div#table-div
    script(type='text/babel').
      class FilterInput extends React.Component {
        constructor(props) {
          super(props);
          this.handleChange = this.handleChange.bind(this);
        }
        handleChange(e) {
          if (e.which == 13) {
            var title = this.props.title;
            var value = e.target.value;
            this.props.change(title, value);
          }
        }
        render() {
          return (
            <div className = 'table-filter-item'>
              <label className = 'table-filter-item-label'>{this.props.label}</label>
              <input className = 'table-filter-item-input' onKeyDown = {this.handleChange} />
            </div>
          );
        }
      }
      class FilterSelect extends React.Component {
        constructor(props) {
          super(props);
          this.handleChange = this.handleChange.bind(this);
        }
        handleChange(e) {
          var title = this.props.title;
          var value = e.target.value;
          this.props.change(title, value);
        }
        render() {
          const options = this.props.options.map((opt) => (
            <option value={opt.value}>{opt.title}</option>
          ));
          return (
            <div className = 'table-filter-item'>
              <label className = 'table-filter-item-label'>{this.props.label}</label>
              <select className = 'table-filter-item-select' onChange = {this.handleChange} >
                {options}
              </select>
            </div>
          );
        }
      }
      class TableLabel extends React.Component {
        constructor(props) {
          super(props);
        }
        render() {
          return (
            <tr className='content-row-label'>
              <th className='content-row-check-label'></th>
              <th className='content-row-index-label'>åºå·</th>
              <th className='content-row-title-label'>æ ‡é¢˜</th>
              <th className='content-row-category-label'>ç±»åˆ«</th>
              <th className='content-row-label-label'>æ ‡ç­¾</th>
              <th className='content-row-status-label'>çŠ¶æ€</th>
              <th className='content-row-pageview-label'>é˜…è¯»æ¬¡æ•°</th>
              <th className='content-row-operation-label'>æ“ä½œ</th>
            </tr>
          );
        }
      }
      class ArticleRow extends React.Component {
        constructor(props) {
          super(props);
          this.state = this.props.article;
          this.article_state_label = {
            on: 'å·²ä¸Šçº¿',
            off: 'å·²ä¸‹çº¿',
            check: 'å¾…æ ¸æŸ¥'
          };
          this.handleStateClick = this.handleStateClick.bind(this);
          this.article_operation = {
            on: <ul className='article-operation-ul'><li data-type='off' onClick = {this.handleStateClick}>ä¸‹çº¿</li><li data-type='check' onClick = {this.handleStateClick}>æ ¸æŸ¥</li></ul>,
            off: <ul className='article-operation-ul'><li data-type='on' onClick = {this.handleStateClick}>ä¸Šçº¿</li><li data-type='check' onClick = {this.handleStateClick}>æ ¸æŸ¥</li></ul>,
            check: <ul className='article-operation-ul'><li data-type='on' onClick = {this.handleStateClick}>ä¸Šçº¿</li><li data-type='check' onClick = {this.handleStateClick}>æ ¸æŸ¥</li><li data-type='del' onClick = {this.handleStateClick}>åˆ é™¤</li></ul>
          }
        }
        handleStateClick(e) {
          var type = e.target.getAttribute('data-type');
          var id = this.state.id;
          var that = this;
          if (type == 'on' || type == 'off') {
            fetch('/admin/datas/articles/modify',
              {
                data: {id: id, state: type},
                type: 'get',
                dataType: 'json',
                success: function(dt) {
                  that.setState(dt.data);
                },
                error: function() {
                  console.log(error);
                }
              }
            );
          } else if (type == 'del') {
            alert(del);
          } else if (type == 'check') {
            location.href = `/admin/articles/modify?id=${id}`;
          }
        }
        render() {
          const url = '/articles/view/' + this.state.id;
          const topStatus = this.state.top == 0 ? {} : {color: '#EF5350'};
          const articleState = this.article_state_label[this.state.state];
          const operation = this.article_operation[this.state.state];
          return (
            <tr className='content-row-data'>
              <td className='content-row-checkbox-data'><input type='checkbox' /></td>
              <td className='content-row-index-data' onClick = {this.handleIndexClick}>{this.props.index + 1}</td>
              <td className='content-row-title-data' style={topStatus}><a href={url}>{this.state.title}</a></td>
              <td className='content-row-category-data'>{this.state.category}</td>
              <td className='content-row-label-data'>{this.state.label}</td>
              <td className='content-row-status-data'>{articleState}</td>
              <td className='content-row-pageview-data'>{this.state.pageview}</td>
              <td className='content-row-operation-data'>{operation}</td>
            </tr>
          );
        }
      }
      class ArticleTable extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            articleDatas: this.props.articleDatas
          };
        }
        render() {
          const articleRows = this.state.articleDatas.map((article, index, arr) => {
            return (
              <ArticleRow key = {index} index = {index} article = {article} />
            );
          });
          return (
            <table className='content-table'>
              <thead>
                <TableLabel />
              </thead>
              <tbody>
                { articleRows }
              </tbody>
              <tfoot>
              </tfoot>
            </table>
          );
        }
      };
      class TableNavLinkLi extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            page: this.props.page,
            title: this.props.title,
            current: this.props.current
          }
          this.handleClick = this.handleClick.bind(this);
        }
        handleClick() {
          this.props.click(this.state.page);
        }
        render() {
          var classes = 'table-nav-ul-li';
          if (this.state.current == this.state.page) classes += ' table-nav-ul-li-current';
          return (
            <li className = {classes} onClick = {this.handleClick}>{this.state.title}</li>
          );
        }
      }
      class TableNavLink extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            page: this.props.page,
            total: this.props.total
          }
          this.getRenderData = this.getRenderData.bind(this);
          this.handleClick = this.handleClick.bind(this);
        }
        handleClick(pg) {
          this.props.pagechange(pg);
        }
        getRenderData() {
          const page = this.state.page;
          const total = this.state.total;
          var start = page < 5 ? 0 : page - 5;
          var len;
          if (start + 10 <= total) {
            len = 10;
          } else if (total - 10 > 0) {
            start = total - 10;
            len = 10;
          } else {
            start = 0;
            len = total;
          }
          var lis = [];
          if (start != 0) lis.push(<TableNavLinkLi page = {start - 1} current = {page} title='ä¸Šä¸€é¡µ' click = {this.handleClick} />);
          for (let i = 1; i <= len; i++)
            lis.push(<TableNavLinkLi page = {start + i - 1} current = {page} title= {start + i} click = {this.handleClick} />);
          if (start + len < total) lis.push(<TableNavLinkLi page = {start + len} current = {page} title = 'ä¸‹ä¸€é¡µ' click = {this.handleClick} />);
          return lis;
        }
        render() {
          const lis = this.getRenderData();
          console.log('render nav link');
          return (
            <ul id = 'table-nav-ul'>
              {lis}
            </ul>
          );
        }
      }
      class ArticleLayout extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            data: this.props.data,
            current: this.props.current,
            total: this.props.total
          }
          this.handlePageChange = this.handlePageChange.bind(this);
          this.handleFilterChange = this.handleFilterChange.bind(this);
          this.fetchSuccess = this.fetchSuccess.bind(this);
          this.fetchData = this.fetchData.bind(this);
          this.filter = {start : 0};
        }
        fetchSuccess(dt) {
          var that = this;
          if (dt.code == 0) {
            that.setState({
              data: dt.data.data,
              current: dt.data.current,
              total: dt.data.total
            });
          }
        }
        fetchData() {
          var that = this;
          fetch('/admin/datas/articles/get', {
            type: 'get',
            data: that.filter,
            dataType: 'json',
            success: that.fetchSuccess
          });
        }
        handlePageChange(i) {
          this.filter.start = i;
          this.fetchData();
        }
        handleFilterChange(label, value) {
          if (this.filter[label] == value) return;
          this.filter[label] = value;
          this.filter.start = 0;
          this.fetchData();
        }
        render() {
          /**
           * å¯èƒ½æœ‰æ›´å¥½çš„æ›´æ–°æ–¹æ³•
           * ä»¥åå†çœ‹çœ‹èƒ½ä¸èƒ½ä¿®æ”¹ğŸ˜Š 
           * å› ä¸ºæˆ‘æ„Ÿè§‰è¿™ä¸ªæ²¡æœ‰é‡ç”¨ï¼Œè€Œæ˜¯é‡æ–°æ¸²æŸ“äº†
           */
          const ky = new Date().getTime();
          const stateOptions = [
            {value: '-1', title: 'å…¨éƒ¨'},
            {value: 'on', title: 'å·²ä¸Šçº¿'},
            {value: 'off', title: 'å·²ä¸‹çº¿'},
            {value: 'check', title: 'å¾…æ ¸æŸ¥'}
          ];
          const opeOptions = [
            {value: '-1', title: '--é€‰æ‹©æ“ä½œ--'}
          ];
          return (
            <div>
              <div className = 'table-filter-bar table-filter-bar-top'>
                <FilterSelect title = 'state' label = 'çŠ¶æ€' options = {stateOptions} change = {this.handleFilterChange} />
                <FilterInput title = 'category' label = 'ç±»åˆ«' change = {this.handleFilterChange} />
                <FilterInput title = 'label' label = 'æ ‡ç­¾' change = {this.handleFilterChange} />
              </div>
              <ArticleTable key = {ky} articleDatas = {this.state.data} />;
              <div className = 'table-filter-bar table-filter-bar-bottom'>
                <FilterSelect options = {opeOptions} />
              </div>
              <TableNavLink key = {ky + 1000} page = {this.state.current} total = {this.state.total} pagechange = {this.handlePageChange} />
            </div>
          );
        }
      }
      /**
       * ä»¥åå†ä¿®æ”¹ä¸‹é¢çš„å‡½æ•°
       * æƒå½“å­¦ä¹ 
       */
      function urlParamsEncode(obj) {
        var param = '';
        for (let key in obj) {
          param += (encodeURIComponent(key) + "=" + encodeURIComponent(obj[key]) + '&');
        }
        return param.substring(0, param.length - 1);
      }
      function fetch(url, {
          data = {}, 
          type = 'get', 
          dataType = 'text', 
          success = function(){}, 
          error = function(){}, 
          complete = function(){}}) {
        var xhr = new XMLHttpRequest();
        if (xhr == null) return;
        var params = urlParamsEncode(data);
        if (type == 'get') {
          if (!url.endsWith('?')) url += '?';
          url += params;
        }
        xhr.open(type, url);
        xhr.onreadystatechange = function () {
          if (xhr.readyState == 4) {
            complete();
            if (xhr.status == 200) {
              switch (dataType) {
                case 'json':
                  success(JSON.parse(xhr.responseText));
                  break;
                case 'xml':
                  success(xhr.responseXML);
                  break;
                case 'text':
                default:
                  success(xhr.responseText);
                  break;
              }
            } else {
              // æ­¤å¤„æ²¡æœ‰å‚æ•°
              error();
            }
          }
        };
        if (type == 'post') {
          xhr.send(params)
        } else {
          xhr.send();
        }
      }
      function getData(start = 0) {
        fetch('/admin/datas/articles/get', {
          type: 'get', 
          data: {start: start},
          dataType: 'json', 
          success: function(dt) {
            ReactDOM.render(
              <ArticleLayout data = {dt.data.data} current = {dt.data.current} total = {dt.data.total} />,
              document.getElementById('table-div')
            );
          }
        });
      }
      getData();