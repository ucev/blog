extends base_layout

block main-body-block
  div.main
    div#main-div
    script(type='text/babel').
      /**
       * 这个决定修改成类
       */
      class AddInputDialog extends React.Component {
        constructor(props) {
          super(props);
          this.handleConfirmClick = this.handleConfirmClick.bind(this);
          this.handleCancelClick = this.handleCancelClick.bind(this);
        }
        handleConfirmClick() {
          var val = this.textInput.value;
          this.props.handleConfirm(val);
          this.textInput.value = "";
        }
        handleCancelClick() {
          this.props.handleCancel();
        }
        render() {
          var componentStyle = {};
          if (!this.props.componentIsVisible)
            componentStyle.display = 'none';
          return (
              <div id = 'add-new-group-div' style = {componentStyle}>
                <div id = 'add-new-group-title'>{this.props.title}</div>
                <input id = 'add-new-group-input' ref = {(input) => (this.textInput = input)}/>
                <div id = 'add-new-group-button-div'>
                  <button id = 'add-new-group-confirm-button' onClick = {this.handleConfirmClick}>确定</button>
                  <button id = 'add-new-group-cancel-button' onClick = {this.handleCancelClick}>取消</button>
                </div>
              </div>
          );
        }
      }
      class PhotoItem extends React.Component {
        constructor(props) {
          super(props);
        }
        render() {
          return (
            <li className = 'photo-flow-item-li'>
              <img className = 'photo-flow-item-li-img' src="/images/rabbit.gif"></img>
              <div className = 'photo-flow-item-li-ope-bar'>
              </div>
            </li>
          );
        }
      }
      class PhotoFlow extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            gid: this.props.gid,
            photos: [],
            start: 0, //暂时没用到，做个标记😊 
          }
          this.handleUploadButtonClick = this.handleUploadButtonClick.bind(this);
          this.handleUploadInputChange = this.handleUploadInputChange.bind(this);
          this.getGroupPhotos = this.getGroupPhotos.bind(this);
          this.getGroupPhotos();
        }
        handleUploadButtonClick(e) {
          var input = this.uploadInput;
          input.click();
        }
        handleUploadInputChange(e) {
          var input = e.target;
          var file = input.files[0];
          var fd = new FormData();
          fd.append('file', file);
          fd.append('gid', this.state.gid);
          fetch('/admin/datas/photos/add', {
            data: fd,
            type: 'post',
            dataType: 'json',
            success: function(dt) {
              console.log(dt);
            },
            error: function(err) {
              console.log('error');
            }
          });
        }
        getGroupPhotos() {
          var that = this;
          fetch('/admin/datas/photos/get', {
            data: {gid: this.state.gid},
            type: 'get',
            dataType: 'json',
            success: function(dt) {
              console.log(dt);
              /*
              if (dt.code == 0) {
                that.setState({
                  photos: dt.data
                });
              }
              */
            }
          })
        }
        render() {
          console.log('rerender');
          
          const items = [];
          for (let i = 0; i < this.props.count; i++) {
            items.push(<PhotoItem />);
          }

          var uploadInputStyles = {
            display: 'none'
          };
          return (
            <div id = 'photo-flow-div'>
              <div className = 'photo-operation-bar' id = 'photo-operation-bar-first'>
                <button id = 'upload-image-button' className='operation-button' onClick = {this.handleUploadButtonClick} >上传图片</button>
                <input ref = {(input) => {this.uploadInput = input;}} id = 'upload-image-input' type = 'file' accept="image/*" style = {uploadInputStyles} onChange = {this.handleUploadInputChange} />
              </div>
              <div className = 'photo-operation-bar' id = 'photo-operation-bar-second'>
                <input type='checkbox' /><label>全选</label>
                <button className = 'operation-button'>移动分组</button>
                <button className = 'operation-button'>删除</button>
              </div>
              <ul id = 'photo-flow-items-ul'>
                {items}
              </ul>
            </div>
          );
        }
      }
      class PhotoGroupBar extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            groups: this.props.groups,
            componentIsVisible: false
          }
          this.handleConfirm = this.handleConfirm.bind(this);
          this.handleCancel = this.handleCancel.bind(this);
          this.handleGroupItemClick = this.handleGroupItemClick.bind(this);
          this.showAddDialog = this.showAddDialog.bind(this);
          this.fetchGroupData = this.fetchGroupData.bind(this);
          this.fetchGroupData();
        }
        showAddDialog() {
          this.setState({
            componentIsVisible: true
          });
        }
        fetchGroupData() {
          var that = this;
          fetch('/admin/datas/photogroup/get', {
            type: 'get',
            dataType: 'json',
            success: function(dt) {
              if (dt.code == 0) {
                that.setState({
                  groups: dt.data
                });
              }
            }
          });
        }
        handleConfirm(groupname) {
          this.setState({
            componentIsVisible: false
          });
          var that = this;
          fetch('/admin/datas/photogroup/modify',{
            data: {groupname: groupname},
            type: 'get',
            dataType: 'json',
            success: function(dt) {
              that.fetchGroupData();
            },
            error: function() {
              console.log('error');
            }
          });
        }
        handleCancel() {
          this.setState({
            componentIsVisible: false
          });
        }
        handleGroupItemClick (e) {
          alert('click');
          var gid = e.target.getAttribute('data-gid');
          this.props.groupChange(gid);
        }
        render() {
          var groupItems = this.state.groups.map((group) => {
            var gid = group.id;
            var classes = 'photo-group-item-li';
            if (gid == this.props.gid) classes += ' photo-group-item-li-current';
            return <li className = {classes} data-gid = {group.id} onClick = {this.handleGroupItemClick}>{group.name}({group.count})</li>
          });
          var componentIsVisible = this.state.componentIsVisible;
          console.log('photo group bar: ' + componentIsVisible);
          var key = new Date().getTime();
          return (
            <div id = 'photo-group-div'>
              <ul id = 'photo-group-items-ul'>
                {groupItems}
                <li id = 'add-new-photo-group-item' className = 'photo-group-item-li' onClick = {this.showAddDialog}>新建分组</li>
              </ul>
              <AddInputDialog title = '新建分组' handleConfirm = {this.handleConfirm} handleCancel = {this.handleCancel} componentIsVisible = {componentIsVisible}/>
            </div>
          );
        }
      }
      class PhotoArea extends React.Component {
        constructor(props) {
          super(props);
          this.state = {
            gid: 1
          }
          this.handlePhotoGroupChange = this.handlePhotoGroupChange.bind(this);
        }
        handlePhotoGroupChange(gid) {
          alert("group change. new id: " + gid);
          this.setState({
            gid: gid
          });
        }
        /**
         * 原本想把这个函数封进PhotoFlow 中
         * 但没有找到合适的更新方法
         * 暂且用 key 来更新
         * 以后再看一看有没有更好的方法
         * 现在这个做个记号😊 
         * 以示可以在这里拉取数据
         * 然后作为 PhotoFlow 的 props 传入
         * 这样封装性不太好
         */
        getGroupPhotos() {

        }
        render() {
          var groups = [];
          var key = new Date().getTime();
          return (
            <div id='photo-div'>
              <PhotoFlow gid = {this.state.gid} count = '200' />
              <PhotoGroupBar key = {key} gid = {this.state.gid} groups = {groups} groupChange = {this.handlePhotoGroupChange}/>
            </div>
          );
        }
      }
      ReactDOM.render(
        <PhotoArea />,
        document.getElementById('main-div')
      );
      function fetch(url, {
          data = {}, 
          type = 'get', 
          dataType = 'text', 
          success = function(){}, 
          error = function(){}, 
          complete = function(){}}) {
        function urlParamsEncode(obj) {
          var param = '';
          for (let key in obj) {
            param += (encodeURIComponent(key) + "=" + encodeURIComponent(obj[key]) + '&');
          }
          return param.substring(0, param.length - 1);
        }
        var xhr = new XMLHttpRequest();
        if (xhr == null) return;
        if (type == 'get') {
          var params = urlParamsEncode(data);
          if (!url.endsWith('?')) url += '?';
          url += params;
        }
        xhr.open(type, url);
        xhr.onreadystatechange = function () {
          if (xhr.readyState == 4) {
            complete();
            if (xhr.status == 200) {
              switch (dataType) {
                case 'json':
                  success(JSON.parse(xhr.responseText));
                  break;
                case 'xml':
                  success(xhr.responseXML);
                  break;
                case 'text':
                default:
                  success(xhr.responseText);
                  break;
              }
            } else {
              // 此处没有参数
              error();
            }
          }
        };
        if (type == 'post') {
          if (data instanceof FormData) {
            xhr.setRequestHeader('content-type', 'multipart/form-data');
            xhr.send(data);
          } else {
            var params = urlParamsEncode(data);
            xhr.setRequestHeader('content-type', 'application/x-www-form-urlencoded');
            xhr.send(params)
          }
        } else {
          xhr.send();
        }
      }